<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OatSense - Precision Agriculture Platform</title>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Leaflet for Maps -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw for Polygon Editing -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <!-- Google Maps Places (Autocomplete) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9Gev9YgDv7urczW7ipSyVdFfnAkxDbD0&libraries=places"></script>
    <!-- changed from here -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              mont: ["Montserrat", "sans-serif"],
              lora: ["Lora", "serif"],
            },
            colors: {
              page: "#FAF6EF",
              navbar: "#A3301E",
              greenCard: "#6D8E2299",
              yellowCard: "#FFC567",
              redCard: "#FF6767",
              blueCard: "#2AB9CF",
            },
          },
        },
      };
    </script>
    <style>
      .layout-canvas {
        padding-left: 100px;
        padding-right: 100px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useRef } = React;

      // ============================================================================
      // CONFIGURATION
      // ============================================================================

      const isLocal = ["localhost", "127.0.0.1", "0.0.0.0"].includes(
        window.location.hostname
      );
      const API_BASE_URL = isLocal
        ? "http://127.0.0.1:8000"
        : window.location.origin;

      const GOOGLE_MAPS_API_KEY = "AIzaSyD9Gev9YgDv7urczW7ipSyVdFfnAkxDbD0";

      // ============================================================================
      // API CLIENT
      // ============================================================================

      const resolveImageUrl = (src) => {
        if (!src) return null;
        if (src.startsWith("http://") || src.startsWith("https://")) return src;
        return `${API_BASE_URL}${src}`;
      };
      const safeParseJson = (value) => {
        try {
          return JSON.parse(value);
        } catch {
          return {};
        }
      };

      class ApiClient {
        constructor() {
          this.token = localStorage.getItem("token");
        }

        setToken(token) {
          this.token = token;
          localStorage.setItem("token", token);
        }

        clearToken() {
          this.token = null;
          localStorage.removeItem("token");
        }

        async request(endpoint, options = {}) {
          const headers = {
            "Content-Type": "application/json",
            ...options.headers,
          };

          if (this.token) {
            headers["Authorization"] = `Bearer ${this.token}`;
          }

          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers,
          });

          if (response.status === 401) {
            this.clearToken();
            window.location.href = "/";
          }

          if (!response.ok) {
            const error = await response
              .json()
              .catch(() => ({ detail: "Request failed" }));
            throw new Error(error.detail || "Request failed");
          }

          return response.json();
        }

        async login(email, password) {
          const data = await this.request("/api/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });
          this.setToken(data.access_token);
          return data;
        }

        async register(email, password, name) {
          const data = await this.request("/api/auth/register", {
            method: "POST",
            body: JSON.stringify({ email, password, name }),
          });
          this.setToken(data.access_token);
          return data;
        }

        async getCurrentUser() {
          return this.request("/api/users/me");
        }

        async getFields(businessId) {
          return this.request(`/api/fields?business_id=${businessId}`);
        }

        async createField(fieldData) {
          return this.request("/api/fields", {
            method: "POST",
            body: JSON.stringify(fieldData),
          });
        }

        async getField(fieldId) {
          return this.request(`/api/fields/${fieldId}`);
        }

        async updateField(fieldId, updates) {
          return this.request(`/api/fields/${fieldId}`, {
            method: "PATCH",
            body: JSON.stringify(updates),
          });
        }

        async deleteField(fieldId) {
          return this.request(`/api/fields/${fieldId}`, {
            method: "DELETE",
          });
        }

        async triggerAnalysis(fieldId) {
          return this.request(`/api/fields/${fieldId}/analyze`, {
            method: "POST",
          });
        }

        async getFieldAnalyses(fieldId, limit = 30) {
          return this.request(`/api/fields/${fieldId}/analyses?limit=${limit}`);
        }

        async getAnalysis(analysisId) {
          return this.request(`/api/analyses/${analysisId}`);
        }

        async getFieldWeather(fieldId) {
          return this.request(`/api/fields/${fieldId}/weather`);
        }

        async getRecommendations(fieldId) {
          return this.request(`/api/fields/${fieldId}/recommendations`);
        }

        async getFieldAlerts(fieldId, status = null) {
          const query = status ? `?status=${status}` : "";
          return this.request(`/api/fields/${fieldId}/alerts${query}`);
        }

        async getFieldAgronomy(fieldId) {
          return this.request(`/api/fields/${fieldId}/agronomy`);
        }

        async getWaporWaterSeries(fieldId, mapset = "ET", limit = 12) {
          const params = new URLSearchParams({ mapset, limit: String(limit) });
          return this.request(
            `/api/fields/${fieldId}/wapor/series?${params.toString()}`
          );
        }

        async acknowledgeAlert(alertId) {
          return this.request(`/api/alerts/${alertId}/acknowledge`, {
            method: "PATCH",
          });
        }

        async resolveAlert(alertId) {
          return this.request(`/api/alerts/${alertId}/resolve`, {
            method: "PATCH",
          });
        }

        async getDashboardSummary(businessId) {
          return this.request(
            `/api/dashboard/summary?business_id=${businessId}`
          );
        }
      }

      const api = new ApiClient();

      // ============================================================================
      // COMPONENTS
      // ============================================================================

      // Dashboard Component
      function Dashboard({ user }) {
        const [selectedBusinessId, setSelectedBusinessId] = useState(null);
        const [summary, setSummary] = useState(null);
        const [fields, setFields] = useState([]);
        const [selectedField, setSelectedField] = useState(null);
        const [view, setView] = useState("overview"); // overview, field-detail, create-field
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          if (user && user.businesses && user.businesses.length > 0) {
            setSelectedBusinessId(user.businesses[0].business_id);
          }
        }, [user]);

        useEffect(() => {
          if (selectedBusinessId) {
            loadDashboardData();
          }
        }, [selectedBusinessId]);

        const loadDashboardData = async () => {
          setLoading(true);
          try {
            const [summaryData, fieldsData] = await Promise.all([
              api.getDashboardSummary(selectedBusinessId),
              api.getFields(selectedBusinessId),
            ]);
            setSummary(summaryData);
            setFields(fieldsData);
          } catch (err) {
            console.error("Failed to load dashboard data:", err);
          } finally {
            setLoading(false);
          }
        };

        const handleLogout = () => {
          api.clearToken();
          window.location.reload();
        };

        const handleFieldSelect = (field) => {
          setSelectedField(field);
          setView("field-detail");
        };

        const handleBack = () => {
          setView("overview");
          setSelectedField(null);
          loadDashboardData();
        };

        return (
          <div className="min-h-screen" style={{ background: "#FAF6EF" }}>
            {/* Header */}
            <header
              className="flex items-center"
              style={{ height: 115, background: "#A3301E" }}
            >
              <div className="w-full flex items-center px-[100px]">
                <div className="flex items-center gap-3">
                  <div className="h-12 w-12 bg-white/20 rounded-full" />
                  <div className="text-white font-mont font-[600]">
                    <div className="text-[18px]">Oatmeal</div>
                    <div className="text-[14px] opacity-90">Farm Network</div>
                  </div>
                </div>

                <nav className="flex-1 flex justify-center gap-8 text-white font-mont text-[18px] font-[600]">
                  {[
                    "Home",
                    "Charlie",
                    "Articles",
                    "Team",
                    "About us",
                    "Join",
                    "Sign in",
                    "Contact us",
                  ].map((i) => (
                    <button key={i} className="hover:opacity-90">
                      {i}
                    </button>
                  ))}
                </nav>
              </div>
            </header>

            {
              /* Main Content */
              // className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
            }
            <main className="w-full overflow-x-hidden">
              <div className="layout-canvas">
                {view === "overview" && (
                  <OverviewView
                    summary={summary}
                    fields={fields}
                    loading={loading}
                    onFieldSelect={handleFieldSelect}
                    onCreateField={() => setView("create-field")}
                  />
                )}

                {view === "field-detail" && selectedField && (
                  <FieldDetailView
                    field={selectedField}
                    onBack={handleBack}
                    onUpdate={loadDashboardData}
                  />
                )}

                {view === "create-field" && (
                  <CreateFieldView
                    businessId={selectedBusinessId}
                    onBack={handleBack}
                    onCreated={handleBack}
                  />
                )}
              </div>
            </main>
          </div>
        );
      }
      // FieldRow component
      function FieldRow({ field }) {
        return (
          <div
            className="bg-[#D9D9D9] rounded-[12px] shadow-lg cursor-pointer w-full"
            style={{ height: 100 }}
          >
            <div className="h-full px-8 flex items-center justify-between gap-4">
              <div className="min-w-0 flex-1">
                <div className="font-lora text-[18px] font-[700] text-black">
                  {field.name}
                </div>
                <div className="flex items-center gap-2 mt-1">
                  <span className="text-red-600 shrink-0">üìç</span>
                  <span className="font-mont text-[16px] font-[700] text-black shrink-0">
                    Location:
                  </span>
                  <span className="font-mont text-[16px] text-black truncate">
                    {field.address}
                  </span>
                </div>
              </div>
              <div className="bg-white px-4 py-1 rounded-md font-mont font-[600] text-black shadow shrink-0 text-[14px]">
                {field.monitoring_enabled ? "Active" : "Inactive"}
              </div>
            </div>
          </div>
        );
      }
      // Overview View
      function OverviewView({
        summary,
        fields,
        loading,
        onFieldSelect,
        onCreateField,
      }) {
        if (loading) {
          return (
            <div className="flex justify-center items-center h-64">
              <div className="text-gray-600">Loading...</div>
            </div>
          );
        }

        return (
          <div>
            {/* CONTENT WRAPPER */}
            <div div className="max-w-[1728px] mx-auto px-[40px] pb-[80px]">
              {/* SUMMARY CARDS */}
              <div className="mt-[40px] flex" style={{ gap: 32 }}>
                <SummaryCard
                  title="Total Field"
                  value={summary?.field_count || 0}
                  bg="#6D8E2299"
                />

                <SummaryCard
                  title="Analysis"
                  value={summary?.analysis_count || 0}
                  bg="#FFC567"
                />

                <SummaryCard
                  title="Open Alerts"
                  value={summary?.open_alerts || 0}
                  bg="#FF6767"
                />

                <SummaryCard
                  title="Average Health"
                  value={summary?.average_health ?? "N/A"}
                  bg="#2AB9CF"
                />
              </div>

              {/* HEADER ROW */}
              <div className="flex items-center justify-between mt-[40px]">
                <div className="font-lora text-[32px] font-[700]">
                  Your Fields
                </div>

                <button
                  onClick={onCreateField}
                  className="bg-[#6D8E22] text-white px-5 py-3 rounded-md font-mont font-[700]"
                >
                  + Add Field
                </button>
              </div>

              {/* FIELD LIST */}
              <div className="flex flex-col gap-[20px] mt-[24px]">
                {fields.map((field) => (
                  <div key={field.fieldid} onClick={() => onFieldSelect(field)}>
                    <FieldRow field={field} />
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }
      // Summary Card Component
      function SummaryCard({ title, value, bg }) {
        return (
          <div
            className="flex-1 rounded-[12px] shadow-lg"
            style={{ height: 140, background: bg }}
          >
            <div className="h-full px-6 py-4 flex flex-col justify-center gap-[10px]">
              <div className="font-mont text-[18px] font-[600] text-black">
                {title}
              </div>
              <div className="font-mont text-[36px] font-[700] text-black">
                {value}
              </div>
            </div>
          </div>
        );
      }

      // Field Card Component
      // Field Card Component
      function FieldCard({ field, onClick }) {
        return (
          <div
            onClick={onClick}
            className="bg-white border border-gray-200 rounded-lg hover:shadow-md transition cursor-pointer"
            style={{
              width: "100%",
              maxWidth: 1600, // keeps Inactive button visible
            }}
          >
            <div className="px-6 py-4">
              {/* Header row */}
              <div className="flex items-start justify-between mb-3">
                <h3 className="font-semibold text-gray-900">{field.name}</h3>

                <span
                  className={`shrink-0 px-3 py-1 rounded text-xs font-medium ${
                    field.monitoring_enabled
                      ? "bg-green-100 text-green-800"
                      : "bg-gray-100 text-gray-800"
                  }`}
                >
                  {field.monitoring_enabled ? "Active" : "Inactive"}
                </span>
              </div>

              {/* Details */}
              <div className="space-y-2 text-sm text-gray-600">
                <div className="flex items-center">
                  <span className="mr-2">üìç</span>
                  <span className="break-words">{field.address}</span>
                </div>

                {field.crop_type && (
                  <div className="flex items-center">
                    <span className="mr-2">üå±</span>
                    <span>{field.crop_type}</span>
                  </div>
                )}

                {field.field_size_hectares && (
                  <div className="flex items-center">
                    <span className="mr-2">üìè</span>
                    <span>{field.field_size_hectares} ha</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Create Field View
      // Updated Create Field View with Address Autocomplete
      function CreateFieldView({ businessId, onBack, onCreated }) {
        const [formData, setFormData] = useState({
          name: "",
          address: "",
          latitude: "",
          longitude: "",
          field_size_hectares: "",
          crop_type: "",
          planting_date: "",
          boundary_geojson: "",
          monitoring_interval_days: 5,
          alert_threshold_health: 50,
        });
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);
        const [addressLocked, setAddressLocked] = useState(false);
        const [suggestions, setSuggestions] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const mapRef = useRef(null);
        const markerRef = useRef(null);
        const drawnItemsRef = useRef(null);
        const searchTimerRef = useRef(null);
        const addressInputRef = useRef(null);
        const placesRef = useRef(null);

        const handleAddressChange = (e) => {
          const value = e.target.value;
          setFormData((prev) => ({ ...prev, address: value }));
          if (addressLocked) {
            setSuggestions([]);
            setShowSuggestions(false);
            return;
          }
          if (window.google?.maps?.places) {
            setSuggestions([]);
            setShowSuggestions(false);
            return;
          }
          if (searchTimerRef.current) {
            clearTimeout(searchTimerRef.current);
          }
          if (value.trim().length < 3) {
            setSuggestions([]);
            setShowSuggestions(false);
            return;
          }
          searchTimerRef.current = setTimeout(async () => {
            try {
              const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&q=${encodeURIComponent(
                value
              )}`;
              const response = await fetch(url, {
                headers: { Accept: "application/json" },
              });
              const data = await response.json();
              setSuggestions(Array.isArray(data) ? data : []);
              setShowSuggestions(true);
            } catch (err) {
              console.error("Address fetch error:", err);
              setSuggestions([]);
              setShowSuggestions(false);
            }
          }, 350);
        };

        const selectAddress = (item) => {
          setFormData((prev) => ({
            ...prev,
            address: item.display_name,
            latitude: parseFloat(item.lat).toFixed(6),
            longitude: parseFloat(item.lon).toFixed(6),
          }));
          setShowSuggestions(false);
          if (mapRef.current) {
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);
            mapRef.current.setView([lat, lon], 15);
            if (markerRef.current) {
              markerRef.current.setLatLng([lat, lon]);
            } else {
              markerRef.current = L.marker([lat, lon]).addTo(mapRef.current);
            }
          }
        };

        const reverseGeocode = async (lat, lon) => {
          try {
            if (GOOGLE_MAPS_API_KEY) {
              const gResp = await fetch(
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${GOOGLE_MAPS_API_KEY}`
              );
              const gData = await gResp.json();
              if (gData?.results?.length) {
                return gData.results[0].formatted_address || "";
              }
            }
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`
            );
            const data = await response.json();
            return data.display_name || "";
          } catch (err) {
            console.error("Reverse geocode error:", err);
            return "";
          }
        };

        const getPolygonCentroid = (geometry) => {
          if (!geometry || geometry.type !== "Polygon") {
            return null;
          }
          const coords = geometry.coordinates?.[0] || [];
          if (coords.length === 0) {
            return null;
          }
          let sumLat = 0;
          let sumLon = 0;
          coords.forEach((c) => {
            sumLon += c[0];
            sumLat += c[1];
          });
          return {
            lat: sumLat / coords.length,
            lon: sumLon / coords.length,
          };
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError("");
          setLoading(true);

          try {
            const data = {
              business_id: businessId,
              name: formData.name,
              address: formData.address,
              latitude: parseFloat(formData.latitude),
              longitude: parseFloat(formData.longitude),
              field_size_hectares: formData.field_size_hectares
                ? parseFloat(formData.field_size_hectares)
                : null,
              crop_type: formData.crop_type || null,
              planting_date: formData.planting_date || null,
              boundary_geojson: formData.boundary_geojson || null,
              monitoring_interval_days: parseInt(
                formData.monitoring_interval_days
              ),
              alert_threshold_health: parseInt(formData.alert_threshold_health),
            };

            const created = await api.createField(data);
            const createdId =
              created?.field_id ?? created?.fieldid ?? created?.id;
            if (createdId) {
              try {
                await api.triggerAnalysis(createdId);
              } catch (err) {
                console.error("Failed to trigger analysis after create:", err);
              }
            }
            onCreated();
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        const handleChange = (e) => {
          setFormData({
            ...formData,
            [e.target.name]: e.target.value,
          });
        };

        useEffect(() => {
          if (mapRef.current || !window.L) {
            return;
          }

          const map = L.map("field-boundary-map").setView([37.5, -121.9], 12);
          mapRef.current = map;

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(map);

          drawnItemsRef.current = new L.FeatureGroup();
          map.addLayer(drawnItemsRef.current);

          const drawControl = new L.Control.Draw({
            draw: {
              polygon: true,
              rectangle: true,
              circle: false,
              circlemarker: false,
              marker: false,
              polyline: false,
            },
            edit: {
              featureGroup: drawnItemsRef.current,
            },
          });
          map.addControl(drawControl);

          map.on(L.Draw.Event.CREATED, (e) => {
            drawnItemsRef.current.clearLayers();
            drawnItemsRef.current.addLayer(e.layer);
            const geojson = e.layer.toGeoJSON().geometry;
            const centroid = getPolygonCentroid(geojson);
            setFormData((prev) => ({
              ...prev,
              boundary_geojson: JSON.stringify(geojson),
              latitude: centroid ? centroid.lat.toFixed(6) : prev.latitude,
              longitude: centroid ? centroid.lon.toFixed(6) : prev.longitude,
            }));
            if (centroid) {
              reverseGeocode(centroid.lat, centroid.lon).then((addr) => {
                const fallback = `${centroid.lat.toFixed(
                  6
                )}, ${centroid.lon.toFixed(6)}`;
                setFormData((prev) => ({
                  ...prev,
                  address: addr || fallback,
                }));
                setAddressLocked(true);
              });
            }
          });

          map.on(L.Draw.Event.EDITED, () => {
            const layers = drawnItemsRef.current.getLayers();
            if (layers.length > 0) {
              const geojson = layers[0].toGeoJSON().geometry;
              const centroid = getPolygonCentroid(geojson);
              setFormData((prev) => ({
                ...prev,
                boundary_geojson: JSON.stringify(geojson),
                latitude: centroid ? centroid.lat.toFixed(6) : prev.latitude,
                longitude: centroid ? centroid.lon.toFixed(6) : prev.longitude,
              }));
              if (centroid) {
                reverseGeocode(centroid.lat, centroid.lon).then((addr) => {
                  const fallback = `${centroid.lat.toFixed(
                    6
                  )}, ${centroid.lon.toFixed(6)}`;
                  setFormData((prev) => ({
                    ...prev,
                    address: addr || fallback,
                  }));
                  setAddressLocked(true);
                });
              }
            }
          });

          map.on(L.Draw.Event.DELETED, () => {
            setFormData((prev) => ({
              ...prev,
              boundary_geojson: "",
            }));
            setAddressLocked(false);
          });

          map.on("click", (e) => {
            const { lat, lng } = e.latlng;
            setFormData((prev) => ({
              ...prev,
              latitude: lat.toFixed(6),
              longitude: lng.toFixed(6),
            }));
            if (markerRef.current) {
              markerRef.current.setLatLng([lat, lng]);
            } else {
              markerRef.current = L.marker([lat, lng]).addTo(map);
            }
            reverseGeocode(lat, lng).then((addr) => {
              const fallback = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
              setFormData((prev) => ({
                ...prev,
                address: addr || fallback,
              }));
              setAddressLocked(true);
            });
          });
        }, []);

        useEffect(() => {
          if (addressLocked) {
            return;
          }
          if (!addressInputRef.current || !window.google?.maps?.places) {
            return;
          }
          if (placesRef.current) {
            return;
          }
          const autocomplete = new window.google.maps.places.Autocomplete(
            addressInputRef.current,
            {
              fields: ["formatted_address", "geometry"],
              types: ["geocode"],
            }
          );
          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place?.geometry?.location) {
              return;
            }
            const lat = place.geometry.location.lat();
            const lon = place.geometry.location.lng();
            const address =
              place.formatted_address || addressInputRef.current.value;
            setFormData((prev) => ({
              ...prev,
              address,
              latitude: lat.toFixed(6),
              longitude: lon.toFixed(6),
            }));
            if (mapRef.current) {
              mapRef.current.setView([lat, lon], 15);
              if (markerRef.current) {
                markerRef.current.setLatLng([lat, lon]);
              } else {
                markerRef.current = L.marker([lat, lon]).addTo(mapRef.current);
              }
            }
          });
          placesRef.current = autocomplete;
        }, [addressLocked]);

        return (
          <div className="max-w-[1728px] mx-auto px-[40px] pb-[80px]">
            <button
              onClick={onBack}
              className="mb-6 text-green-600 hover:text-green-700 font-medium flex items-center"
            >
              ‚Üê Back to Overview
            </button>

            <div className="bg-white rounded-lg shadow-sm p-8">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">
                Add New Field
              </h2>

              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Field Name *
                    </label>
                    <input
                      type="text"
                      name="name"
                      value={formData.name}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      required
                    />
                  </div>

                  {/* Address Autocomplete Section */}
                  <div className="md:col-span-2 relative">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Address (auto-filled from map)
                    </label>
                    <input
                      type="text"
                      name="address"
                      value={formData.address}
                      onChange={handleAddressChange}
                      readOnly={addressLocked}
                      ref={addressInputRef}
                      className={`w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 ${
                        addressLocked ? "bg-gray-50" : ""
                      }`}
                      placeholder="Start typing or click the map"
                      autoComplete="off"
                    />
                    {showSuggestions &&
                      !addressLocked &&
                      suggestions.length > 0 && (
                        <ul className="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-auto">
                          {suggestions.map((item, idx) => (
                            <li
                              key={idx}
                              onClick={() => selectAddress(item)}
                              className="px-4 py-2 hover:bg-green-50 cursor-pointer text-sm border-b border-gray-100 last:border-0"
                            >
                              {item.display_name}
                            </li>
                          ))}
                        </ul>
                      )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Latitude *
                    </label>
                    <input
                      type="number"
                      step="0.000001"
                      name="latitude"
                      value={formData.latitude}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-gray-50"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Longitude *
                    </label>
                    <input
                      type="number"
                      step="0.000001"
                      name="longitude"
                      value={formData.longitude}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-gray-50"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Field Size (hectares) *
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      name="field_size_hectares"
                      value={formData.field_size_hectares}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      min="0.01"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Crop Type *
                    </label>
                    <input
                      type="text"
                      name="crop_type"
                      value={formData.crop_type}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      placeholder="e.g., Wheat, Corn"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Planting Date *
                    </label>
                    <input
                      type="date"
                      name="planting_date"
                      value={formData.planting_date}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      required
                    />
                  </div>

                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Field Boundary (GeoJSON Polygon, optional)
                    </label>
                    <div
                      id="field-boundary-map"
                      className="leaflet-container mb-3"
                    ></div>
                    <textarea
                      name="boundary_geojson"
                      value={formData.boundary_geojson}
                      onChange={handleChange}
                      rows="3"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 font-mono text-xs"
                      placeholder='{"type":"Polygon","coordinates":[[...]]}'
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Optional. Draw your field on the map or paste a GeoJSON
                      Polygon.
                    </p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Monitoring Interval (days)
                    </label>
                    <input
                      type="number"
                      name="monitoring_interval_days"
                      value={formData.monitoring_interval_days}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      min="1"
                      max="30"
                    />
                  </div>

                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Alert Threshold (Health Score %)
                    </label>
                    <input
                      type="number"
                      name="alert_threshold_health"
                      value={formData.alert_threshold_health}
                      onChange={handleChange}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                      min="0"
                      max="100"
                    />
                    <p className="text-sm text-gray-500 mt-1">
                      Alert when health score drops below this value
                    </p>
                  </div>
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    {error}
                  </div>
                )}

                <div className="flex justify-end space-x-4">
                  <button
                    type="button"
                    onClick={onBack}
                    className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    disabled={loading}
                    className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition disabled:opacity-50"
                  >
                    {loading ? "Creating..." : "Create Field"}
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      // Field Detail View
      function FieldDetailView({ field, onBack, onUpdate }) {
        const [activeTab, setActiveTab] = useState("overview");
        const [analyses, setAnalyses] = useState([]);
        const [weather, setWeather] = useState(null);
        const [recommendations, setRecommendations] = useState([]);
        const [alerts, setAlerts] = useState([]);
        const [agronomy, setAgronomy] = useState(null);
        const [waporSeries, setWaporSeries] = useState(null);
        const [loading, setLoading] = useState(false);
        const [analyzing, setAnalyzing] = useState(false);
        useEffect(() => {
          const handlePopState = () => onBack();
          window.history.pushState(null, "", window.location.href);
          window.addEventListener("popstate", handlePopState);
          return () => window.removeEventListener("popstate", handlePopState);
        }, []);
        useEffect(() => {
          loadFieldData();
        }, [field.fieldid]);

        const loadFieldData = async () => {
          setLoading(true);
          try {
            const [
              analysesData,
              weatherData,
              recommendationsData,
              alertsData,
              agronomyData,
              waporData,
            ] = await Promise.all([
              api.getFieldAnalyses(field.fieldid, 10),
              api.getFieldWeather(field.fieldid),
              api.getRecommendations(field.fieldid),
              api.getFieldAlerts(field.fieldid, "open"),
              api.getFieldAgronomy(field.fieldid),
              api.getWaporWaterSeries(field.fieldid, "ET", 24),
            ]);

            setAnalyses(analysesData.analyses);
            setWeather(weatherData);
            setRecommendations(recommendationsData.recommendations);
            setAlerts(alertsData.alerts);
            setAgronomy(agronomyData);
            setWaporSeries(waporData);
          } catch (err) {
            console.error("Failed to load field data:", err);
          } finally {
            setLoading(false);
          }
        };

        const handleTriggerAnalysis = async () => {
          setAnalyzing(true);
          try {
            await api.triggerAnalysis(field.fieldid);
            // Removed blocking browser alert; UI already shows "Analyzing..."
            setTimeout(loadFieldData, 5000);
          } catch (err) {
            console.error("Failed to trigger analysis:", err);
          } finally {
            setAnalyzing(false);
          }
        };

        const handleAcknowledgeAlert = async (alertId) => {
          try {
            await api.acknowledgeAlert(alertId);
            loadFieldData();
          } catch (err) {
            console.error("Failed to acknowledge alert:", err);
          }
        };

        return (
          <div>
            {/* Field Header */}
            <div className="flex items-start justify-between mt-[40px] mb-[30px]">
              <div>
                <h1 className="font-lora text-[22px] font-[700] text-black mb-2">
                  {field.name}
                </h1>
                <div className="flex items-center gap-3">
                  <svg
                    width="16"
                    height="20"
                    viewBox="0 0 16 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    className="shrink-0 mt-1"
                  >
                    <path
                      d="M8 0C3.58 0 0 3.58 0 8C0 13.25 8 20 8 20C8 20 16 13.25 16 8C16 3.58 12.42 0 8 0ZM8 10.5C6.62 10.5 5.5 9.38 5.5 8C5.5 6.62 6.62 5.5 8 5.5C9.38 5.5 10.5 6.62 10.5 8C10.5 9.38 9.38 10.5 8 10.5Z"
                      fill="#FF0000"
                    />
                  </svg>
                  <span className="font-mont text-[16px] font-[700] text-black">
                    Location:
                  </span>
                  <span className="font-mont text-[16px] font-[500] text-black">
                    {field.address}
                  </span>
                </div>
              </div>
              <button
                onClick={handleTriggerAnalysis}
                disabled={analyzing}
                className="bg-[#6D8E22] text-white px-6 py-3 rounded-md font-mont font-[700] disabled:opacity-50"
              >
                {analyzing ? "Analyzing..." : "Run Analysis"}
              </button>
            </div>

            {/* Alerts Banner */}
            {alerts.length > 0 && (
              <div
                className="rounded-[12px] p-6 mb-[30px]"
                style={{
                  background: "#FF000026",
                  border: "1px solid #FF0000",
                  boxShadow: "0px 4px 4px 0px #00000040",
                }}
              >
                <div className="font-lora text-[18px] font-[700] text-[#FF0000] mb-4">
                  ‚ö†Ô∏è {alerts.length} Active Alert{alerts.length > 1 ? "s" : ""}
                </div>
                <div className="flex flex-col gap-3">
                  {alerts.map((alert) => {
                    const alertId = alert.alert_id ?? alert.alertid ?? alert.id;
                    return (
                      <div
                        key={alertId ?? JSON.stringify(alert)}
                        className="flex items-center justify-between px-6 rounded-[12px]"
                        style={{
                          background: "#F6F6F6",
                          minHeight: 83,
                          boxShadow: "0px 4px 4px 0px #00000040",
                        }}
                      >
                        <span className="font-mont text-[14px] font-[500] text-black">
                          {alert.message || alert.alert_type}
                        </span>
                        <button
                          onClick={() => handleAcknowledgeAlert(alertId)}
                          className="bg-[#FF0000] text-white px-6 py-2 rounded-[10px] font-mont font-[600] shrink-0 ml-4"
                        >
                          Acknowledge
                        </button>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            {/* Tabs */}
            {/* Tabs */}
            <div className="mb-[40px]">
              <div className="flex items-center justify-between mb-6">
                <div>
                  {activeTab === "weather" && (
                    <h2 className="font-lora text-[30px] font-[700] text-black">
                      Current Weather Conditions
                    </h2>
                  )}
                </div>
                <div className="flex gap-3">
                  {["overview", "analyses", "weather", "recommendations"].map(
                    (tab) => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className="font-mont text-[14px] font-[600] px-4 py-2 rounded-[10px] transition"
                        style={{
                          background: activeTab === tab ? "#6D8E22" : "#D9D9D9",
                          color: activeTab === tab ? "white" : "black",
                        }}
                      >
                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                      </button>
                    )
                  )}
                </div>
              </div>

              {loading ? (
                <div className="text-center py-12 text-gray-600">
                  Loading...
                </div>
              ) : (
                <>
                  {activeTab === "overview" && (
                    <OverviewTab
                      field={field}
                      analyses={analyses}
                      recommendations={recommendations}
                      agronomy={agronomy}
                      waporSeries={waporSeries}
                    />
                  )}
                  {activeTab === "analyses" && (
                    <AnalysesTab analyses={analyses} />
                  )}
                  {activeTab === "weather" && <WeatherTab weather={weather} />}
                  {activeTab === "recommendations" && (
                    <RecommendationsTab recommendations={recommendations} />
                  )}
                </>
              )}
            </div>
          </div>
        );
      }

      // Overview Tab
      function OverviewTab({
        field,
        analyses,
        recommendations,
        agronomy,
        waporSeries,
      }) {
        const latestAnalysis = analyses[0];
        const gdd = agronomy?.gdd;
        const growthStage = agronomy?.growth_stage;
        const spray = agronomy?.spray_decision;
        const irrigation = agronomy?.irrigation_advice;
        const disease = agronomy?.disease_risk;
        const getIndex = (analysis, name) => {
          if (!analysis || !Array.isArray(analysis.vegetation_indices))
            return null;
          return analysis.vegetation_indices.find((i) => i.index_type === name);
        };
        const ndviLatest = getIndex(latestAnalysis, "NDVI")?.mean;
        const ndviPrev = getIndex(analyses[1], "NDVI")?.mean;
        const ndviDelta =
          ndviLatest != null && ndviPrev != null ? ndviLatest - ndviPrev : null;
        const freshnessDays = agronomy?.freshness_days;
        const actions = agronomy?.action_checklist || [];
        const lastAnalysisDate = agronomy?.last_analysis_date;
        const lastValidSatellite = agronomy?.last_valid_satellite;
        const cloudPercent = agronomy?.cloud_percent;
        const confidence = agronomy?.confidence;
        const opticalRecent = agronomy?.optical_recent;
        const radarProxy = agronomy?.radar_proxy;
        const waterBalance = agronomy?.water_balance;
        const wapor = waporSeries?.wapor;
        const waporData = wapor?.series || [];
        const waporLatest = waporData[0]?.stats?.mean ?? null;
        const [waterView, setWaterView] = useState("cumulative");
        const MM_TO_IN = 1 / 25.4;
        const missingIndices = ["NDVI", "NDRE", "EVI", "GNDVI", "NDWI"].filter(
          (name) => !getIndex(latestAnalysis, name)
        );

        const Sparkline = ({ values }) => {
          if (!values || values.length < 2) return null;
          const min = Math.min(...values);
          const max = Math.max(...values);
          const range = max - min || 1;
          const points = values
            .map((v, i) => {
              const x = (i / (values.length - 1)) * 100;
              const y = 100 - ((v - min) / range) * 100;
              return `${x},${y}`;
            })
            .join(" ");
          return (
            <svg viewBox="0 0 100 100" className="w-full h-8">
              <polyline
                fill="none"
                stroke="#16a34a"
                strokeWidth="4"
                points={points}
              />
            </svg>
          );
        };

        const WaterContentChart = ({
          series,
          view,
          lastDate,
          modelLabel,
          acres,
        }) => {
          const canvasRef = useRef(null);
          const chartRef = useRef(null);
          const cleanSeries = Array.isArray(series)
            ? series.filter((s) => s?.stats?.mean != null)
            : [];

          useEffect(() => {
            if (!canvasRef.current || cleanSeries.length === 0) return;
            if (chartRef.current) {
              chartRef.current.destroy();
            }
            const sorted = [...cleanSeries]
              .filter((s) => s && s.date)
              .sort((a, b) => String(a.date).localeCompare(String(b.date)));
            const monthLabels = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            const parsed = sorted
              .map((s) => {
                const raw = String(s.date);
                const dt = new Date(`${raw}T00:00:00Z`);
                return {
                  raw,
                  dt,
                  value: Number(s.stats.mean) * MM_TO_IN,
                };
              })
              .filter((p) => !Number.isNaN(p.dt.getTime()));

            const uniqueYears = Array.from(
              new Set(parsed.map((p) => p.dt.getUTCFullYear()))
            );

            let chartLabels = [];
            let datasets = [];

            if (parsed.length === 0) {
              if (chartRef.current) {
                chartRef.current.destroy();
                chartRef.current = null;
              }
              return;
            }

            if (view === "cumulative" && parsed.length > 0) {
              const byYear = {};
              parsed.forEach((p) => {
                const year = p.dt.getUTCFullYear();
                const monthIndex = p.dt.getUTCMonth();
                if (!byYear[year]) byYear[year] = Array(12).fill(null);
                byYear[year][monthIndex] = p.value;
              });
              const years = Object.keys(byYear)
                .map(Number)
                .sort((a, b) => a - b);
              const colors = [
                "#111827",
                "#2563eb",
                "#16a34a",
                "#9333ea",
                "#f97316",
                "#0ea5e9",
                "#10b981",
              ];
              datasets = years.map((year, idx) => {
                let acc = 0;
                const data = (byYear[year] || Array(12).fill(null)).map((v) => {
                  if (v == null) return null;
                  acc += v;
                  return acc;
                });
                return {
                  label: `${year} ${modelLabel || "ET"}`,
                  data,
                  borderColor: colors[idx % colors.length],
                  backgroundColor: "rgba(0, 0, 0, 0)",
                  borderWidth: 2,
                  tension: 0.35,
                  fill: false,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  pointBackgroundColor: colors[idx % colors.length],
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 1,
                  spanGaps: true,
                };
              });
              chartLabels = monthLabels;
            } else {
              const timeline = parsed.slice(-60);
              const data = timeline.map((p) => p.value);
              chartLabels = timeline.map((p) => p.raw);
              datasets = [
                {
                  label: `${modelLabel || "Ensemble ET"}`,
                  data,
                  borderColor: "#111827",
                  borderWidth: 2.5,
                  backgroundColor: "rgba(0,0,0,0)",
                  tension: 0.35,
                  fill: false,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  pointBackgroundColor: "#111827",
                  pointBorderColor: "#111827",
                  pointBorderWidth: 1,
                  spanGaps: true,
                },
              ];
            }

            const allValues = datasets.flatMap((d) =>
              d.data.filter((v) => v != null)
            );
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            const pad =
              (maxVal - minVal) * 0.15 ||
              Math.max(Math.abs(minVal), Math.abs(maxVal), 1) * 0.15;
            const yMin = minVal - pad;
            const yMax = maxVal + pad;
            chartRef.current = new Chart(canvasRef.current, {
              type: "line",
              data: {
                labels: chartLabels,
                datasets,
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: {
                  legend: { display: true, position: "bottom" },
                  title: {
                    display: true,
                    text:
                      view === "cumulative"
                        ? "Cumulative Evapotranspiration"
                        : "Evapotranspiration",
                  },
                  tooltip: {
                    backgroundColor: "#111827",
                    padding: 10,
                    callbacks: {
                      title: (items) => {
                        if (!items.length) return "";
                        return items[0].label;
                      },
                      label: (ctx) => {
                        const inches = ctx.parsed.y;
                        const af = acres ? (inches / 12) * acres : null;
                        const afText =
                          af != null ? ` (${af.toFixed(2)} AF)` : "";
                        return `Ensemble ET: ${inches.toFixed(2)} in${afText}`;
                      },
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Evapotranspiration (in)",
                      font: { weight: "600" },
                    },
                    grid: { color: "#f3f4f6", drawBorder: false },
                    ticks: { stepSize: 1, callback: (v) => v.toFixed(2) },
                  },
                  x: {
                    grid: { display: false },
                    ticks: {
                      color: "#6b7280",
                      callback: (value, index) => {
                        if (view === "cumulative") {
                          return chartLabels[index];
                        }
                        const raw = chartLabels[index];
                        if (!raw) return "";
                        const dt = new Date(`${raw}T00:00:00Z`);
                        if (Number.isNaN(dt.getTime())) return "";
                        const m = dt.getUTCMonth();
                        if (m === 0 || m === 6) {
                          return dt.toLocaleString("en-US", {
                            month: "short",
                            year: "numeric",
                          });
                        }
                        return "";
                      },
                    },
                  },
                },
              },
            });
            return () => {
              if (chartRef.current) chartRef.current.destroy();
            };
          }, [series, view]);

          if (cleanSeries.length === 0) {
            return (
              <div className="text-sm text-gray-500">
                Water series unavailable.
              </div>
            );
          }

          return (
            <div className="h-48">
              <canvas ref={canvasRef}></canvas>
            </div>
          );
        };

        return (
          <div className="space-y-6">
            {/* Latest Health Score */}
            {latestAnalysis && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-6">
                  <div className="text-sm font-medium text-gray-600 mb-2">
                    Current Health Score
                  </div>
                  <div className="text-4xl font-bold text-green-600 mb-2">
                    {latestAnalysis.health_score}%
                  </div>
                  <div className="text-sm text-gray-600">
                    Status:{" "}
                    <span className="font-medium">{latestAnalysis.status}</span>
                  </div>
                  {freshnessDays != null && (
                    <div className="text-xs text-gray-500 mt-2">
                      {freshnessDays <= 7 ? "Fresh" : "Stale"} ({freshnessDays}d
                      ago)
                    </div>
                  )}
                </div>

                <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-6">
                  <div className="text-sm font-medium text-gray-600 mb-2">
                    NDVI (Vegetation)
                  </div>
                  {Array.isArray(latestAnalysis.vegetation_indices) &&
                    latestAnalysis.vegetation_indices.find(
                      (i) => i.index_type === "NDVI"
                    ) && (
                      <>
                        <div className="text-4xl font-bold text-blue-600 mb-2">
                          {latestAnalysis.vegetation_indices
                            .find((i) => i.index_type === "NDVI")
                            .mean.toFixed(2)}
                        </div>
                        <div className="text-sm text-gray-600">
                          Range:{" "}
                          {latestAnalysis.vegetation_indices
                            .find((i) => i.index_type === "NDVI")
                            .min.toFixed(2)}{" "}
                          -
                          {latestAnalysis.vegetation_indices
                            .find((i) => i.index_type === "NDVI")
                            .max.toFixed(2)}
                        </div>
                        {ndviDelta != null && (
                          <div className="text-xs text-gray-500 mt-2">
                            {ndviDelta > 0 ? "‚ñ≤" : ndviDelta < 0 ? "‚ñº" : "‚ñ†"}{" "}
                            {ndviDelta.toFixed(2)} vs last
                          </div>
                        )}
                      </>
                    )}
                  {!Array.isArray(latestAnalysis.vegetation_indices) && (
                    <div className="text-sm text-gray-600">
                      Unavailable (radar-only)
                    </div>
                  )}
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6">
                  <div className="text-sm font-medium text-gray-600 mb-2">
                    Last Analysis
                  </div>
                  <div className="text-xl font-bold text-purple-600 mb-2">
                    {new Date(
                      latestAnalysis.analysis_date
                    ).toLocaleDateString()}
                  </div>
                  <div className="text-sm text-gray-600">
                    Cloud: {latestAnalysis.cloud_percent?.toFixed(1)}%
                  </div>
                </div>
              </div>
            )}

            {/* Data Freshness & Confidence */}
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="text-sm font-medium text-gray-700 mb-2">
                Data Freshness
              </div>
              <div className="text-sm text-gray-600">
                Last valid satellite:{" "}
                {lastValidSatellite
                  ? new Date(lastValidSatellite).toLocaleDateString()
                  : "Unavailable"}
              </div>
              <div className="text-sm text-gray-600">
                Cloud cover:{" "}
                {cloudPercent != null
                  ? `${cloudPercent.toFixed(1)}%`
                  : "Unavailable"}{" "}
                | Confidence: {confidence || "Unavailable"}
              </div>
              {agronomy?.next_pass?.window_start && (
                <div className="text-sm text-gray-600 mt-1">
                  Next possible pass window:{" "}
                  {new Date(
                    agronomy.next_pass.window_start
                  ).toLocaleDateString()}{" "}
                  ‚Äì{" "}
                  {new Date(agronomy.next_pass.window_end).toLocaleDateString()}
                  {agronomy?.next_pass?.revisit_days
                    ? ` (‚âà${agronomy.next_pass.revisit_days} day revisit)`
                    : ""}
                </div>
              )}
              {agronomy?.cloud_risk && (
                <div className="text-sm text-gray-600 mt-1">
                  Cloud risk now: {agronomy.cloud_risk}
                </div>
              )}
              {opticalRecent === false && radarProxy && (
                <div className="text-sm text-amber-700 mt-2">
                  No optical NDVI in the last 5 days due to cloud cover. Showing
                  radar proxy below.
                </div>
              )}
            </div>

            {/* Vegetation Indices */}
            {latestAnalysis && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-3">
                  Vegetation Indices
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  {["NDVI", "NDRE", "EVI", "GNDVI", "NDWI"].map((name) => {
                    const index = getIndex(latestAnalysis, name);
                    return (
                      <div
                        key={name}
                        className="border border-gray-200 rounded-lg p-4"
                      >
                        <div className="text-sm text-gray-600 mb-1">{name}</div>
                        <div className="text-xl font-semibold text-gray-900">
                          {index ? index.mean.toFixed(2) : "Unavailable"}
                        </div>
                        {index && (
                          <div className="text-xs text-gray-500">
                            Range {index.min.toFixed(2)} -{" "}
                            {index.max.toFixed(2)}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                {missingIndices.length > 0 && (
                  <div className="text-xs text-gray-500 mt-2">
                    Some indices are unavailable because no valid optical data
                    was found in the last {5} days.
                  </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <div className="border border-gray-200 rounded-lg p-3">
                    <div className="text-xs text-gray-600 mb-1">
                      NDVI Trend (last 6)
                    </div>
                    <Sparkline
                      values={analyses
                        .slice(0, 6)
                        .map((a) => getIndex(a, "NDVI")?.mean)
                        .filter((v) => v != null)
                        .reverse()}
                    />
                  </div>
                  <div className="border border-gray-200 rounded-lg p-3">
                    <div className="text-xs text-gray-600 mb-1">
                      NDRE Trend (last 6)
                    </div>
                    <Sparkline
                      values={analyses
                        .slice(0, 6)
                        .map((a) => getIndex(a, "NDRE")?.mean)
                        .filter((v) => v != null)
                        .reverse()}
                    />
                  </div>
                </div>
              </div>
            )}

            {/* Water (ET) */}
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <h3 className="font-semibold text-gray-900">
                    Water Use (ET)
                  </h3>
                  <div className="text-xs text-gray-500">
                    Variable: {wapor?.variable || wapor?.mapset || "ET"}
                  </div>
                  {wapor?.last_date && (
                    <div className="text-xs text-gray-500">
                      Updated: {new Date(wapor.last_date).toLocaleDateString()}
                    </div>
                  )}
                </div>
                <div className="text-sm text-gray-600">
                  Latest:{" "}
                  {waporLatest != null
                    ? (waporLatest * MM_TO_IN).toFixed(2)
                    : "Unavailable"}{" "}
                  in
                </div>
              </div>
              <div className="flex items-center gap-2 mb-3">
                <button
                  className={`px-3 py-1 rounded-full text-xs ${
                    waterView === "monthly"
                      ? "bg-blue-600 text-white"
                      : "bg-gray-100 text-gray-700"
                  }`}
                  onClick={() => setWaterView("monthly")}
                >
                  Monthly
                </button>
                <button
                  className={`px-3 py-1 rounded-full text-xs ${
                    waterView === "cumulative"
                      ? "bg-blue-600 text-white"
                      : "bg-gray-100 text-gray-700"
                  }`}
                  onClick={() => setWaterView("cumulative")}
                >
                  Cumulative
                </button>
              </div>
              <WaterContentChart
                series={waporData}
                view={waterView}
                lastDate={wapor?.last_date}
                modelLabel="ET"
                acres={
                  field?.field_size_hectares
                    ? field.field_size_hectares * 2.47105
                    : null
                }
              />
            </div>

            {/* Satellite Images */}
            {latestAnalysis &&
              (latestAnalysis.ndvi_url || latestAnalysis.image_urls) && (
                <div className="border border-gray-200 rounded-lg p-5 bg-white">
                  <div className="text-center text-sm font-semibold text-gray-700 mb-4">
                    Crop Health Dashboard for{" "}
                    {field?.address || "Selected Field"}
                  </div>
                  <div className="flex flex-col md:flex-row md:items-start md:gap-6">
                    <div className="flex-1 grid grid-cols-2 md:grid-cols-5 gap-4">
                      {(() => {
                        const urls =
                          typeof latestAnalysis.image_urls === "string"
                            ? safeParseJson(latestAnalysis.image_urls)
                            : latestAnalysis.image_urls || {};
                        const fallbackNdvi =
                          latestAnalysis.ndvi_url || urls.NDVI;
                        const indexImages = [
                          {
                            key: "NDVI",
                            title: "NDVI",
                            src: urls.NDVI || fallbackNdvi,
                          },
                          { key: "NDRE", title: "NDRE", src: urls.NDRE },
                          { key: "EVI", title: "EVI", src: urls.EVI },
                          { key: "GNDVI", title: "GNDVI", src: urls.GNDVI },
                          { key: "NDWI", title: "NDWI", src: urls.NDWI },
                        ]
                          .map((item) => ({
                            ...item,
                            src: resolveImageUrl(item.src),
                          }))
                          .filter((item) => item.src);

                        return indexImages.map((img) => (
                          <div
                            key={img.key}
                            className="flex flex-col items-center"
                          >
                            <div className="text-xs font-semibold text-gray-700 mb-2">
                              {img.title}
                            </div>
                            <img
                              src={img.src}
                              alt={img.key}
                              className="w-full rounded-md border border-gray-200"
                            />
                          </div>
                        ));
                      })()}
                    </div>

                    <div className="mt-4 md:mt-0 flex items-center gap-3">
                      <div className="flex flex-col items-center text-xs text-gray-600">
                        <div>0.8</div>
                        <div
                          className="h-40 w-4 rounded border border-gray-300"
                          style={{
                            background:
                              "linear-gradient(to top, #b10026, #f03b20, #feb24c, #c7e9b4, #2ca25f, #006837)",
                          }}
                        />
                        <div>-0.2</div>
                      </div>
                      <div className="text-xs text-gray-600">Index Value</div>
                    </div>
                  </div>
                </div>
              )}

            {/* Top Recommendations */}
            {recommendations.length > 0 && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-3">
                  Top Recommendations
                </h3>
                <div className="space-y-3">
                  {recommendations.slice(0, 3).map((rec, idx) => (
                    <div
                      key={idx}
                      className="bg-blue-50 border border-blue-200 rounded-lg p-4"
                    >
                      <div className="flex items-start justify-between mb-2">
                        <h4 className="font-medium text-blue-900">
                          {rec.title}
                        </h4>
                        <span
                          className={`px-2 py-1 rounded text-xs font-medium ${
                            rec.priority === "high"
                              ? "bg-red-100 text-red-800"
                              : rec.priority === "medium"
                              ? "bg-yellow-100 text-yellow-800"
                              : "bg-green-100 text-green-800"
                          }`}
                        >
                          {rec.priority}
                        </span>
                      </div>
                      <p className="text-sm text-gray-700">{rec.description}</p>
                      {rec.estimated_savings && (
                        <p className="text-sm text-green-600 mt-2 font-medium">
                          Est. Savings: ${rec.estimated_savings}
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Changes Since Last Check */}
            <div>
              <h3 className="font-semibold text-gray-900 mb-3">
                Changes Since Last Check
              </h3>
              {analyses.length < 2 ? (
                <div className="text-sm text-gray-600">
                  Need at least two analyses to show changes.
                </div>
              ) : (
                <div className="space-y-2">
                  {["NDVI", "NDRE", "EVI", "GNDVI", "NDWI"].map((name) => {
                    const latest = getIndex(analyses[0], name)?.mean;
                    const prev = getIndex(analyses[1], name)?.mean;
                    if (latest == null || prev == null) return null;
                    const delta = latest - prev;
                    const dir = delta > 0 ? "up" : delta < 0 ? "down" : "flat";
                    return (
                      <div key={name} className="text-sm text-gray-700">
                        {name}: {dir} ({delta.toFixed(2)})
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Today's Actions */}
            <div>
              <h3 className="font-semibold text-gray-900 mb-3">
                Today's Actions
              </h3>
              {actions.length === 0 ? (
                <div className="text-sm text-gray-600">
                  No action items based on available data.
                </div>
              ) : (
                <ul className="space-y-2">
                  {actions.map((item, idx) => (
                    <li
                      key={idx}
                      className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-800"
                    >
                      {item}
                    </li>
                  ))}
                </ul>
              )}
            </div>

            {/* Agronomy Snapshot */}
            <div>
              <h3 className="font-semibold text-gray-900 mb-3">
                Agronomy Snapshot
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="border border-gray-200 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">
                    GDD (¬∞C¬∑days)
                  </div>
                  <div className="text-xl font-semibold text-gray-900">
                    {gdd ? Math.round(gdd.gdd) : "Unavailable"}
                  </div>
                  {gdd && (
                    <div className="text-xs text-gray-500">
                      Base {gdd.base_temp_c}¬∞C ‚Ä¢{" "}
                      {gdd.start_date
                        ? new Date(gdd.start_date).toLocaleDateString()
                        : "start"}{" "}
                      ‚Üí{" "}
                      {gdd.end_date
                        ? new Date(gdd.end_date).toLocaleDateString()
                        : "today"}
                    </div>
                  )}
                  {!gdd && (!field.crop_type || !field.planting_date) && (
                    <div className="text-xs text-gray-500 mt-1">
                      Add crop type + planting date to calculate GDD.
                    </div>
                  )}
                </div>
                <div className="border border-gray-200 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">Growth Stage</div>
                  <div className="text-xl font-semibold text-gray-900">
                    {growthStage ? growthStage.stage : "Unavailable"}
                  </div>
                  {growthStage && (
                    <div className="text-xs text-gray-500">
                      Model: {growthStage.model}
                      {gdd?.gdd ? ` ‚Ä¢ GDD ${Math.round(gdd.gdd)}` : ""}
                    </div>
                  )}
                  {!growthStage &&
                    (!field.crop_type || !field.planting_date) && (
                      <div className="text-xs text-gray-500 mt-1">
                        Add crop type + planting date to estimate growth stage.
                      </div>
                    )}
                </div>
                <div className="border border-gray-200 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">
                    Spray Decision
                  </div>
                  <div className="text-xl font-semibold text-gray-900">
                    {spray ? spray.decision : "Unavailable"}
                  </div>
                  {spray?.reasons?.length > 0 && (
                    <div className="text-xs text-gray-500">
                      Reasons: {spray.reasons.join(", ")}
                    </div>
                  )}
                </div>
                <div className="border border-gray-200 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">Irrigation</div>
                  <div className="text-xl font-semibold text-gray-900">
                    {irrigation ? irrigation.status : "Unavailable"}
                  </div>
                  {irrigation && (
                    <div className="text-xs text-gray-500">
                      NDWI {irrigation.ndwi_mean?.toFixed(2)} | 3d rain{" "}
                      {irrigation.forecast_precip_3d_mm}mm
                    </div>
                  )}
                  {waterBalance && (
                    <div className="text-xs text-gray-500 mt-1">
                      7d balance {waterBalance.balance_mm}mm (ET0{" "}
                      {waterBalance.et0_mm} / rain {waterBalance.precip_mm})
                    </div>
                  )}
                </div>
                <div className="border border-gray-200 rounded-lg p-4">
                  <div className="text-sm text-gray-600 mb-1">
                    Disease/Pest Risk
                  </div>
                  <div className="text-xl font-semibold text-gray-900">
                    {disease ? disease.risk : "Unavailable"}
                  </div>
                  {disease && (
                    <div className="text-xs text-gray-500">
                      NDVI drop {disease.ndvi_drop ?? "n/a"}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {!latestAnalysis && (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">üìä</div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">
                  No analysis data yet
                </h3>
                <p className="text-gray-600">
                  Run your first analysis to see field health metrics
                </p>
              </div>
            )}
          </div>
        );
      }

      function AnalysesTab({ analyses }) {
        const getHealthStyle = (score) => {
          if (score >= 70) return { color: "#21D727", label: "Good" };
          if (score >= 50) return { color: "#FFA500", label: "Average" };
          return { color: "#ED1A1A", label: "Bad" };
        };

        const getIndex = (analysis, name) => {
          if (!analysis || !Array.isArray(analysis.vegetation_indices))
            return null;
          return analysis.vegetation_indices.find((i) => i.index_type === name);
        };

        if (analyses.length === 0) {
          return (
            <div className="text-center py-12">
              <div className="text-4xl mb-4">üìä</div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                No analyses yet
              </h3>
              <p className="text-gray-600">
                Run an analysis to start tracking field health
              </p>
            </div>
          );
        }

        return (
          <div
            className="rounded-[20px] p-6 w-full"
            style={{
              background: "#6D8E2266",
              boxShadow: "0px 4px 4px 0px #00000040",
            }}
          >
            <div className="flex flex-col gap-4">
              {analyses.map((analysis) => {
                const { color, label } = getHealthStyle(analysis.health_score);
                const ndvi = getIndex(analysis, "NDVI");
                const ndre = getIndex(analysis, "NDRE");
                const evi = getIndex(analysis, "EVI");

                return (
                  <div
                    key={analysis.analysis_id}
                    className="bg-white rounded-[12px] px-6 py-4"
                    style={{ boxShadow: "0px 4px 4px 0px #00000040" }}
                  >
                    <div className="flex items-center justify-between">
                      {/* LEFT SIDE */}
                      <div className="flex-1">
                        <div className="font-lora text-[18px] font-[700] text-black">
                          {new Date(analysis.analysis_date).toLocaleDateString(
                            "en-GB",
                            {
                              day: "numeric",
                              month: "long",
                              year: "numeric",
                            }
                          )}
                        </div>
                        <div className="font-mont text-[13px] font-[500] text-black mt-1">
                          {analysis.cloud_percent != null
                            ? `Cloud Cover: ${analysis.cloud_percent.toFixed(
                                1
                              )}%`
                            : ""}
                        </div>
                        <div className="flex gap-16 mt-3">
                          <div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              NDVI
                            </div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              {ndvi ? ndvi.mean.toFixed(3) : "N/A"}
                            </div>
                          </div>
                          <div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              NDRE
                            </div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              {ndre ? ndre.mean.toFixed(3) : "N/A"}
                            </div>
                          </div>
                          <div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              EVI
                            </div>
                            <div className="font-mont text-[13px] font-[500] text-black">
                              {evi ? evi.mean.toFixed(3) : "N/A"}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* RIGHT SIDE ‚Äî Donut ring */}
                      <div className="flex flex-col items-center gap-1 shrink-0">
                        <div
                          style={{
                            width: 64,
                            height: 64,
                            borderRadius: "50%",
                            background: `conic-gradient(${color} ${analysis.health_score}%, #D9D9D9 0%)`,
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                          }}
                        >
                          <div
                            style={{
                              width: 44,
                              height: 44,
                              borderRadius: "50%",
                              background: "white",
                            }}
                          />
                        </div>
                        <div
                          className="font-mont text-[12px] font-[600] text-center"
                          style={{ color }}
                        >
                          {analysis.health_score}% : {label}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // Weather Tab
      function WeatherTab({ weather }) {
        if (!weather) {
          return (
            <div className="text-center py-12 text-gray-600">
              Loading weather data...
            </div>
          );
        }
        const current = weather.current;
        if (!current) {
          return (
            <div className="text-center py-12 text-gray-600">
              Weather data unavailable.
            </div>
          );
        }
        const tempC = current.temp_c ?? current.temperature;
        const humidity = current.humidity;
        const windKph = current.wind_kph ?? current.wind_speed;
        const precipMm = current.precip_mm ?? current.precipitation;
        const forecast = weather.forecast || [];

        return (
          <div
            className="rounded-[20px] p-8 w-full"
            style={{
              background: "#C2CD9D",
              boxShadow: "0px 4px 4px 0px #00000040",
            }}
          >
            {/* Current Conditions */}
            <div className="grid grid-cols-4 gap-4 mb-8">
              <div
                className="rounded-[12px] p-4"
                style={{ background: "#DEECFF" }}
              >
                <div className="font-mont text-[13px] font-[600] text-gray-700 mb-1">
                  Temperature
                </div>
                <div className="font-mont text-[22px] font-[700] text-blue-600">
                  {tempC}¬∞C
                </div>
              </div>
              <div
                className="rounded-[12px] p-4"
                style={{ background: "#C8F2F4" }}
              >
                <div className="font-mont text-[13px] font-[600] text-gray-700 mb-1">
                  Humidity
                </div>
                <div className="font-mont text-[22px] font-[700] text-blue-600">
                  {humidity}%
                </div>
              </div>
              <div
                className="rounded-[12px] p-4"
                style={{ background: "#D2F0DB" }}
              >
                <div className="font-mont text-[13px] font-[600] text-gray-700 mb-1">
                  Wind Speed
                </div>
                <div className="font-mont text-[22px] font-[700] text-blue-600">
                  {windKph} km/h
                </div>
              </div>
              <div
                className="rounded-[12px] p-4"
                style={{ background: "#F4E9FF" }}
              >
                <div className="font-mont text-[13px] font-[600] text-gray-700 mb-1">
                  Precipitation
                </div>
                <div className="font-mont text-[22px] font-[700] text-blue-600">
                  {precipMm} mm
                </div>
              </div>
            </div>

            {/* 14-Day Forecast */}
            {forecast.length > 0 && (
              <div>
                <h3 className="font-lora text-[18px] font-[700] text-black mb-4">
                  14-Day Forecast
                </h3>
                <div className="flex flex-col gap-3">
                  {forecast.map((day, idx) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between bg-white rounded-[12px] px-6 py-4"
                    >
                      <div className="flex items-center gap-4">
                        <span className="font-mont text-[14px] font-[600] text-black">
                          {new Date(day.date).toLocaleDateString("en-US", {
                            weekday: "long",
                            month: "long",
                            day: "numeric",
                          })}
                        </span>
                        <span className="text-2xl">
                          {day.day.condition.icon ? "‚òÄÔ∏è" : "üå§Ô∏è"}
                        </span>
                        <span className="font-mont text-[16px] text-gray-600">
                          {day.day.condition.text}
                        </span>
                      </div>
                      <div className="flex gap-6 font-mont text-[13px]">
                        <span>
                          Max: <strong>{day.day.maxtemp_c}¬∞C</strong>
                        </span>
                        <span>
                          Min: <strong>{day.day.mintemp_c}¬∞C</strong>
                        </span>
                        <span>
                          Rain: <strong>{day.day.daily_chance_of_rain}%</strong>
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      }

      // Recommendations Tab
      function RecommendationsTab({ recommendations }) {
        if (recommendations.length === 0) {
          return (
            <div className="text-center py-12">
              <div className="text-4xl mb-4">üí°</div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                No recommendations yet
              </h3>
              <p className="text-gray-600">
                Run an analysis to get AI-powered recommendations
              </p>
            </div>
          );
        }

        return (
          <div className="space-y-4">
            {recommendations.map((rec, idx) => (
              <div key={idx} className="border border-gray-200 rounded-lg p-6">
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-1">
                      {rec.title}
                    </h3>
                    <div className="flex items-center space-x-2 text-sm">
                      <span
                        className={`px-2 py-1 rounded font-medium ${
                          rec.priority === "high"
                            ? "bg-red-100 text-red-800"
                            : rec.priority === "medium"
                            ? "bg-yellow-100 text-yellow-800"
                            : "bg-green-100 text-green-800"
                        }`}
                      >
                        {rec.priority.toUpperCase()}
                      </span>
                      <span className="text-gray-600">
                        Confidence: {(rec.confidence_score * 100).toFixed(0)}%
                      </span>
                    </div>
                  </div>
                  {rec.estimated_savings && (
                    <div className="text-right">
                      <div className="text-sm text-gray-600">Est. Savings</div>
                      <div className="text-2xl font-bold text-green-600">
                        ${rec.estimated_savings}
                      </div>
                    </div>
                  )}
                </div>

                <p className="text-gray-700">{rec.description}</p>

                <div className="mt-4 pt-4 border-t border-gray-200 text-sm text-gray-600">
                  Type:{" "}
                  <span className="font-medium">{rec.recommendation_type}</span>
                </div>
              </div>
            ))}
          </div>
        );
      }

      // ============================================================================
      // MAIN APP (Login Removed)
      // ============================================================================

      function App() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          loadDefaultUser();
        }, []);

        const loadDefaultUser = async () => {
          try {
            // We now just ask the backend "who am I?" without needing a token first
            // The backend is updated to return the default admin user automatically.
            const userData = await api.getCurrentUser();

            // We also need to fetch the business list manually since we skipped the login logic
            // that usually handles this setup.
            // Note: Your backend API might need a tweak to return businesses with the user,
            // but for now we will assume the backend "get_current_user" works.

            // QUICK FIX: Construct a user object that the Dashboard expects
            // Since the raw user endpoint might not return the 'businesses' array structure
            // strictly required by the dashboard, we mock it if missing.
            if (!userData.businesses) {
              // Fetch the business ID (assuming the backend fix created one)
              const fields = await api.getFields(1); // Try ID 1 blindly or fetch real list
              userData.businesses = [{ business_id: 1, name: "My Farm" }];
            }

            setUser(userData);
          } catch (err) {
            console.error("Error loading default user:", err);
          } finally {
            setLoading(false);
          }
        };

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
              <div className="text-xl text-gray-600">Loading Farm Data...</div>
            </div>
          );
        }

        // Directly render Dashboard without checking isAuthenticated
        return <Dashboard user={user} />;
      }

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
